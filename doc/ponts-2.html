<!DOCTYPE html>
<html>
<head>
    <title>Ponts Thermiques</title>
    <meta charset="utf-8">
    <link href="../assets/css/bootstrap.css" rel="stylesheet">
    <script type="text/javascript" src="../assets/js/jquery-3.7.0.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap.bundle.min.js"></script>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Gestion des Ponts Thermiques</h2>
        <div id="bridgeFormsHead"></div>
        
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <button id="prevBridge" class="btn btn-secondary" disabled>Précédent</button>
                <button id="nextBridge" class="btn btn-secondary" disabled>Suivant</button>
            </div>
            <span id="bridgeCounter">Pont thermique 1/1</span>
            <button id="addBridge" class="btn btn-primary">Ajouter un pont thermique</button>
            <button id="finish" class="btn btn-success">Terminé</button>
        </div>
        <textarea id="debug" class="form-control mt-3" rows="5" readonly></textarea>
    </div>

    <script>
        let bridges = [];
        let currentIndex = 0;

        function getHashData() {
            try {
                return JSON.parse(decodeURIComponent(window.location.hash.substring(1))) || [];
            } catch (e) {
                return [];
            }
        }

        function updateBridgeCounter() {
            $("#bridgeCounter").text(`Pont thermique ${currentIndex + 1}/${bridges.length}`);
            $("#prevBridge").prop("disabled", currentIndex === 0);
            $("#nextBridge").prop("disabled", currentIndex >= bridges.length - 1);
        }

        function showBridgeForm(index) {
            $(".bridgeForm").addClass("hidden");
            $(`.bridge_${index}`).removeClass("hidden");
            currentIndex = index;
            updateBridgeCounter();
        }

        function addBridgeForm(index, data = { name: "", type: "", length: "0" }) {
            $("#bridgeFormsHead").append(`
            <div id="bridge_${index}_head" class="bridge_${index} bridgeForm">
                <div class="row">
                    <p>Ce mur accueil-il un plancher/dalle ou un mur de refend ? Si oui il est susceptible de provoquer un pont thermique.
                    A noter que les ponts thermiques sont négligées au niveau des liaisons avec des parois en structure bois.</p>
                </div>
                <div class="row">
                    <div class="col">
                        <input type="text" class="form-control bridgeName" placeholder="Nom du pont" data-index="${index}" value="${data.name}">
                    </div>
                    <div class="col-sm">    
                        <label for="bridgeType_${index}">Type de pont thermique : :</label>
                        <select class="form-select bridgeType" data-index="${index}"  style="width: 100%;" id="bridgeType_${index}">
                            <option value="" ${data.type === "" ? "selected" : ""}>Aucun</option>
                            <option value="floor_lower_wall" ${data.type === "floor_lower_wall" ? "selected" : ""}>Plancher bas / mur</option>
                            <option value="floor_inter_wall" ${data.type === "floor_inter_wall" ? "selected" : ""}>Plancher intermédiaire / mur</option>
                            <option value="floor_high_wall" ${data.type === "floor_high_wall" ? "selected" : ""}>Plancher haut / mur</option>
                            <option value="partition_wall" ${data.type === "partition_wall" ? "selected" : ""}>Refend / mur</option>
                        </select>
                    </div>
                    <div class="col-sm form_hide form_floor_lower_wall form_floor_inter_wall form_floor_high_wall form_partition_wall">
                        <label for="lBridge" class="form_hide form_floor_lower_wall form_floor_high_wall form_floor_inter_wall">Longueur de contact entre le plancher le mur : </label>
                        <label for="lBridge" class="form_hide form_partition_wall">Longueur du contact entre le mur de refend le mur extérieur : </label>
                        <div class="input-group has-validation">
                            <input type="number" class="form-control bridgeLength" step="0.1" id="lBridge" placeholder="Longueur Ex: 12.5" data-index="${index}" value="${data.length}">
                            <span class="input-group-text">m</span>
                        </div>
                        <div class="form-text form_hide form_partition_wall">Souvent la longueur du mur</div>
                        <div class="form-text form_hide form_floor_lower_wall form_floor_high_wall form_floor_inter_wall">Souvent la hauteur du mur</div>
                    </div>
                    
                </div>
                <div class="row form_hide form_floor_lower_wall form_floor_inter_wall form_floor_high_wall form_partition_wall">
                    <div class="col-sm">
                        <label for="bridgeWallTypeInsulation_${index}">Méthode d'isolation du mur : :</label>
                        <select class="form-select form-control bridgeWallTypeInsulation" data-index="${index}"  style="width: 100%;" id="bridgeWallTypeInsulation_${index}">
                            <option value="no">Non Isolé</option>
                            <option value="ITI">ITI : Isolation par l'intérieur</option>
                            <option value="ITE">ITE : Isolation par l'extérieur</option>
                            <option value="ITR">ITR : Isolation répartie (la structure est isolante)</option>
                            <option value="ITI+ITE">ITI+ITE</option>
                            <option value="ITI+ITR">ITI+ITR</option>
                            <option value="ITE+ITR">ITE+ITR</option>
                        </select>
                    </div>
                    <div class="col-sm form_hide form_floor_lower_wall form_floor_high_wall">
                        <label for="floorTypeInsulation">Méthode d'isolation du plancher : :</label>
                        <select class="form-select form-control typeInsulation" style="width: 100%;" id="floorTypeInsulation" class="form_hide form_floor_lower_wall form_floor_high_wall">
                            <option value="no">Non Isolé</option>
                            <option value="ITI">ITI : Isolation par l'intérieur</option>
                            <option value="ITE">ITE : Isolation par l'extérieur</option>
                            <option value="ITI+ITE">ITI+ITE</option>
                        </select>
                    </div>
                </div>
            </div>
            `);
            
            $("#bridgeForms").append(`
                <div id="bridge_${index}_head" class="bridge_${index} bridgeForm">
                    <div class="row mb-3">
                        <div class="col">
                            <input type="text" class="form-control bridgeName" placeholder="Nom du pont" data-index="${index}" value="${data.name}">
                        </div>
                        <div class="col">
                            <select class="form-select bridgeType" data-index="${index}">
                                <option value="" ${data.type === "" ? "selected" : ""}>Type de pont</option>
                                <option value="floor_lower_wall" ${data.type === "floor_lower_wall" ? "selected" : ""}>Plancher bas / mur</option>
                                <option value="floor_inter_wall" ${data.type === "floor_inter_wall" ? "selected" : ""}>Plancher intermédiaire / mur</option>
                                <option value="floor_high_wall" ${data.type === "floor_high_wall" ? "selected" : ""}>Plancher haut / mur</option>
                                <option value="partition_wall" ${data.type === "partition_wall" ? "selected" : ""}>Refend / mur</option>
                            </select>
                        </div>
                        <div class="col">
                            <input type="number" class="form-control bridgeLength" step="0.1" placeholder="Longueur (m)" data-index="${index}" value="${data.length}">
                        </div>
                    </div>
                </div>
            `);
        }

        $("#addBridge").click(() => {
            let index = bridges.length;
            let newBridge = { name: "", type: "", length: "0" };
            bridges.push(newBridge);
            addBridgeForm(index, newBridge);
            showBridgeForm(index);
        });

        $("#prevBridge").click(() => {
            if (currentIndex > 0) showBridgeForm(currentIndex - 1);
        });

        $("#nextBridge").click(() => {
            if (currentIndex < bridges.length - 1) showBridgeForm(currentIndex + 1);
        });

        $("#finish").click(() => {
            $(".bridgeForm").each((index, form) => {
                let name = $(form).find(".bridgeName").val();
                let type = $(form).find(".bridgeType").val();
                let length = $(form).find(".bridgeLength").val();
                bridges[index] = { name, type, length };
            });
            let jsonData = JSON.stringify(bridges, null, 2);
            console.log(jsonData);
            $("#debug").val(jsonData);
        });

        // Initialisation avec les données de l'URL
        bridges = getHashData();
        if (bridges.length === 0) {
            bridges.push({ name: "", type: "", length: "0" });
        }
        bridges.forEach((bridge, index) => addBridgeForm(index, bridge));
        showBridgeForm(0);
    </script>
</body>
</html>
